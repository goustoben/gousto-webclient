import { ResponseMiddleware } from '../types'
import { composeParser } from '../compose'
import { parseResponseToJSON } from './json'
import { hasProp, isRealObject } from '../util'

/**
 * Represents the type of a successful Core request.
 * This format is generated by BaseController.php in Core
 */
type CoreData<T> = {
  status: 'ok',
  result: {
    data: T
  }
}

/**
 * Response parser middleware for extracting data from a Core PHP service request
 * Set the result type using the generic
 *
 * Example:
 *
 * composeFetch(
 *   coreEndpoint,
 *   extractCoreData<User>()
 * )
 */
export function extractCoreData <T> (): ResponseMiddleware<Response, T> {
  return composeParser(
    parseResponseToJSON,
    parseValueToCoreData,
    (value: CoreData<unknown>) => value.result.data as T
  )
}

export function parseValueToCoreData (value: unknown): CoreData<unknown> {
  if (!isRealObject(value)) {
    throw new ParseCoreDataError(`value must be non-null object, was ${typeof value} ${value}`)
  }

  if (!hasProp('status', value) || value.status !== 'ok') {
    throw new ParseCoreDataError(`*.status is not "ok", was ${typeof value.status} ${value.status}`)
  }

  if (!hasProp('result', value) || !isRealObject(value.result)) {
    throw new ParseCoreDataError(`*.result does not exist`)
  }

  if (!isRealObject(value.result)) {
    throw new ParseCoreDataError(`*.result must be non-null object, was ${typeof value.result} ${value.result}`)
  }

  if (!hasProp('data', value.result)) {
    throw new ParseCoreDataError('*.result.data does not exist')
  }

  return value as CoreData<unknown>
}

/**
 * Represents an error parsing data as CoreData
 * Translation: "I couldn't parse this Response.json() result into a Core response!"
 */
class ParseCoreDataError extends Error {
  constructor (reason: string) {
    super(`@library/http ParseCoreDataError: could not parse CoreData; ${reason}`)
  }
}
