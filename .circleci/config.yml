---
version: 2.1

gousto_platform_image: &gousto_platform_image
    - image: ${AWS_ACCOUNT_NUMBER}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${GOUSTO_ENVIRONMENT}/circleci-image/platformdeploy:latest
      aws_auth:
        aws_access_key_id: $AWS_ERC_ACCESS_KEY
        aws_secret_access_key: $AWS_ERC_SECRET_KEY

gousto_node_image: &gousto_node_image
    - image: ${AWS_ACCOUNT_NUMBER}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${GOUSTO_ENVIRONMENT}/circleci-image/node14:latest
      aws_auth:
        aws_access_key_id: $AWS_ERC_ACCESS_KEY
        aws_secret_access_key: $AWS_ERC_SECRET_KEY

circleci_node_image: &circleci_node_image
  - image: cimg/node:14.18.1
    user: root

circleci_node_browsers_image: &circleci_node_browsers_image #image has browser dependencies installed, but not browsers themselves
  - image: cimg/node:14.18.1-browsers
    user: root

orbs:
  browser-tools: circleci/browser-tools@1.1.3
  aws-cli: circleci/aws-cli@1.4.1

commands:
  gzip:
    description: "Apply gzip compression to text files"
    parameters:
      target:
        type: string
    steps:
      - run: echo "Compressing in << parameters.target >>. Initial size - $(du -sh << parameters.target >>)"
      - run: find << parameters.target >> -type f \( -iname '*.js' -or -iname '*.css' \) -exec gzip "{}" \; -exec mv "{}.gz" "{}" \;
      - run: echo "Size after compression - $(du -sh << parameters.target >>)"

  upload-to-s3:
    description: "Upload public dir to S3 bucket"
    parameters:
      bucket:
        type: string
      path:
        type: string
        default: src/apps/webclient/public/
    steps:
      - run: echo "Uploading to << parameters.bucket >>"
      - run:
         name: Upload all text files, sets gzip content-encoding header
         command: aws s3 cp << parameters.path >> << parameters.bucket >> --exclude "*" --include "*.js" --include "*.css" --recursive --content-encoding gzip --cache-control max-age=315360000,no-transform,public --acl public-read
      - run:
         name: Upload binary files to S3, does not set gzip content-encoding header
         command: aws s3 cp << parameters.path >> << parameters.bucket >> --exclude "*.js" --exclude "*.css" --recursive --cache-control max-age=315360000,no-transform,public --acl public-read

  codeartifact_authenticate:
    description: Authenticate with AWS CodeArtifact for Yarn 2.X+
    steps:
      - run:
          name: Authenticate with AWS CodeArtifact for Yarn 2.X+
          command: |
            yarn config unset npmScopes &&
            CODEARTIFACT_AUTH_TOKEN=`aws codeartifact get-authorization-token --domain gousto --domain-owner 472493421475 --query authorizationToken --output text` &&
            yarn config set npmRegistryServer "https://gousto-472493421475.d.codeartifact.eu-west-1.amazonaws.com/npm/proxy-repository/" &&
            yarn config set 'npmRegistries["https://gousto-472493421475.d.codeartifact.eu-west-1.amazonaws.com/npm/proxy-repository/"].npmAuthToken' "${CODEARTIFACT_AUTH_TOKEN}" &&
            yarn config set 'npmRegistries["https://gousto-472493421475.d.codeartifact.eu-west-1.amazonaws.com/npm/proxy-repository/"].npmAlwaysAuth' "true"

  codeartifact_cleanup:
    description: Unset yarn config to prevent issues in other pipelines caused by image caching
    steps:
      - run:
          name: Clean up yarn config for CodeArtifact
          command: |
            yarn config unset npmRegistryServer &&
            yarn config unset npmScopes &&
            yarn config unset npmRegistries["https://gousto-472493421475.d.codeartifact.eu-west-1.amazonaws.com/npm/proxy-repository/"]
      - run:
          name: Clear yarn Cache
          command: yarn cache clear
      - run:
          name: Clear npm config
          command: npm config delete //gousto-472493421475.d.codeartifact.eu-west-1.amazonaws.com/npm/proxy-repository/

jobs:
  setup-ci-variables-scripts:
    docker: *gousto_platform_image #stock image missing /gousto directory
    resource_class: medium
    working_directory: /mnt/ramdisk
    steps:
      - checkout
      - run:
          name: Download platform deploy scripts and set the ENVIRONMENT variable from the branch name
          command: /gousto/platform-setup.sh
      - run:
          name: Set S3 Cloudfront URL
          command: |
            source ~/.circlerc && CLOUDFRONT_URL=$(python ./ci_scripts/describe_platform.py --name=content_output_assetsdistributiondomainname --region=$AWS_DEFAULT_REGION)
            echo "export CLOUDFRONT_URL=$CLOUDFRONT_URL" >> ~/.circlerc
      - setup_remote_docker
      - run:
          name: Setup ECR
          command: source ~/.circlerc && python ./ci_scripts/create_image.py --setup
          no_output_timeout: 10m
      - persist_to_workspace:
          root: /
          paths:
            - root/.circlerc
            - mnt/ramdisk/.yarn
            - mnt/ramdisk/ansible
            - mnt/ramdisk/ci_scripts
            - mnt/ramdisk/cloudformation
            - mnt/ramdisk/images
            - mnt/ramdisk/package.json
            - mnt/ramdisk/scripts
            - mnt/ramdisk/setup
            - mnt/ramdisk/src
            - mnt/ramdisk/tests
            - mnt/ramdisk/.eslintrc.js
            - mnt/ramdisk/.yarnrc.yml
            - mnt/ramdisk/service.yml
            - mnt/ramdisk/tsconfig.json
            - mnt/ramdisk/yarn.lock

  install-dependencies:
    docker: *gousto_node_image
    resource_class: medium
    working_directory: /mnt/ramdisk
    steps:
      - setup_remote_docker
      - attach_workspace:
          at: /
      - run:
          name: Setup Github SSH access
          command: ssh-keyscan -H github.com >> ~/.ssh/known_hosts
      - codeartifact_authenticate
      - run:
          name: Install dependencies
          command: yarn install --immutable
      - codeartifact_cleanup
      - persist_to_workspace:
          root: /
          paths:
            - mnt/ramdisk/node_modules # Also contains .yarn-state.yml
            # Workspace node_modules
            - mnt/ramdisk/src
            - mnt/ramdisk/tests
            # Regression test Cypress binary
            - root/.cache/Cypress
            # Yarn install-state.gz
            - mnt/ramdisk/.yarn

  test-typecheck-and-report:
    docker: *circleci_node_image
    resource_class: medium
    working_directory: ~/project/mnt/ramdisk #removed it from the actual ramdisk directory as it uses too much system resources for jest to correctly run. When we can actually use a bigger node machine this can be moved back like the other steps
    environment:
      TZ: "Europe/London"
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Typecheck (feature modules)
          command: yarn workspaces foreach --include '@features/*' --verbose run typecheck
      - run:
          name: Unit test (feature modules)
          command: yarn workspaces foreach --include '@features/*' --verbose run test:unit
      - run:
          name: Test (apps/webclient)
          working_directory: src/apps/webclient
          command: yarn test:jest:ci
      - run:
         name: Typecheck tests (apps/webclient)
         working_directory: src/apps/webclient
         command: yarn typecheck:tests
      - persist_to_workspace:
          root: ~/project
          paths:
            - mnt/ramdisk/src/apps/webclient/coverage/coverage-summary.json

  eslint-generate-report:
    docker: *circleci_node_image
    resource_class: medium
    working_directory: /mnt/ramdisk
    environment:
      TZ: "Europe/London"
    steps:
      - attach_workspace:
          at: /
      - run:
          name: Lint (modules)
          command: yarn workspaces foreach --include '@features/*' --verbose run lint
      - run:
          name: Lint & gather report (apps/webclient)
          working_directory: src/apps/webclient
          command: scripts/run-eslint-ci.sh
      - persist_to_workspace:
          root: /
          paths:
            - mnt/ramdisk/src/apps/webclient/eslint-results.json

  publish-code-health:
    docker: *circleci_node_image
    resource_class: medium
    working_directory: /mnt/ramdisk
    environment:
      TZ: "Europe/London"
    steps:
      - attach_workspace:
          at: /
      - run:
          name: Setup output folder
          command: mkdir /tmp/artifacts
      - run:
          name: Generate code health
          working_directory: src/apps/webclient
          command: node ./scripts/print-code-health.js > /tmp/artifacts/${CODE_HEALTH_FILE_NAME}
      - store_artifacts:
          path: /tmp/artifacts

  build-webclient:
    docker: *circleci_node_image
    resource_class: large
    working_directory: /mnt/ramdisk
    steps:
      - attach_workspace:
          at: /
      - run:
          name: Setup environment and npm variables for build
          command: source ~/.circlerc && setup/setup-common.sh
      - run: echo $ENVIRONMENT
      - run:
          name: Build webclient
          working_directory: src/apps/webclient
          # Use NPM for now to inject setup-common npm config vars; BODA should supercede this
          command: source ~/.circlerc && NODE_CONFIG_ENV=${ENVIRONMENT} NODE_APP_INSTANCE="live" CIRCLE_BUILD_NUM=${CIRCLE_BUILD_NUM} npm run build
      - persist_to_workspace:
          root: /
          paths:
            - mnt/ramdisk/src

  upload-source-maps-to-datadog:
    docker: *circleci_node_image
    working_directory: /mnt/ramdisk
    steps:
      - attach_workspace:
          at: /
      - run:
          name: Upload sourcemaps to datadog
          working_directory: src/apps/webclient
          command: source ~/.circlerc && DATADOG_API_KEY="${DATADOG_SOURCE_MAPS_TOKEN}" DATADOG_SITE="datadoghq.eu" BUILD_DIR="./public" CIRCLE_BUILD_NUM="${CIRCLE_BUILD_NUM}" ASSET_URL_PREFIX="https://${ENVIRONMENT}-assets.gousto.info/build/latest/" yarn datadog:upload-sourcemaps

  upload-assets-to-s3:
    docker: *gousto_platform_image
    resource_class: medium
    working_directory: /mnt/ramdisk
    steps:
      - attach_workspace:
          at: /
      # The build puts its results into `dist` for server, and into `public`
      # for client.  The asset files in the latter are a superset of the ones
      # in former, except for the icon files.  We need those to appear at the
      # bucket, so before uploading we copy them into public (from which we do
      # the upload).
      - run:
          name: Make sure icon files will get uploaded
          command: cp dist/*.ico public
          working_directory: src/apps/webclient
      - gzip:
          target: src/apps/webclient/public
      - run:
          name: Set assets bucket variable
          command: |
            echo 'source ~/.circlerc && export ASSETS_BUCKET=s3://s3-gousto-${ENVIRONMENT}-assets/build' >> $BASH_ENV
      - upload-to-s3:
          bucket: ${ASSETS_BUCKET}/latest/
      - upload-to-s3:
          bucket: ${ASSETS_BUCKET}/${CI_BUILD_NUMBER}/

  create-and-upload-webclient-docker-image-to-ecr:
    docker: *gousto_platform_image #stock image missing boto
    resource_class: medium
    working_directory: /mnt/ramdisk
    steps:
      - setup_remote_docker
      - attach_workspace:
          at: /
      - run:
          name: Create and upload webclient docker image to ECR
          command: source ~/.circlerc && python ./ci_scripts/create_image.py --name webclient
          no_output_timeout: 20m

  test-e2e:
    docker: *circleci_node_browsers_image
    resource_class: medium
    working_directory: /mnt/ramdisk
    steps:
      - attach_workspace:
          at: /
      - run:
          name: Install CI dependencies
          command: apt-get -y update && apt-get -y install jq
      - browser-tools/install-chrome:
          chrome-version: 96.0.4664.110
      - browser-tools/install-chromedriver
      - aws-cli/setup:
          aws-access-key-id: AWS_ERC_ACCESS_KEY
          aws-secret-access-key: AWS_ERC_SECRET_KEY
          aws-region: AWS_DEFAULT_REGION
      - run:
          name: Lease CI node access to public ALB
          working_directory: scripts
          command: source ~/.circlerc && ./lease-access.sh
      - run:
          name: Find Datadog RUM sessions for E2E tests here ⬇️
          command: echo "https://datadoghq.eu/rum/explorer?query=%40application.id%3A7eaa558f-a187-40c5-b743-9fd52d7aff3a&tab=session&from_ts=1640000000000&to_ts=1740000000000&live=true"
      - run:
          name: Run E2E tests
          working_directory: tests/e2e
          command: chromedriver start & yarn test:staging
      - store_test_results:
          path: tests/e2e/reports
      - store_artifacts:
          path: tests/e2e/reports
      - run:
          name: Cleanup CI IP access to ALB WAF
          when: always
          command: aws wafv2 update-ip-set --name $ipsetName --scope $ipsetScope --id $ipsetId --lock-token $nextLockToken --addresses $ipsetAddresses

  test-regression:
    parameters:
      platform:
        type: string
      test_command:
        type: string
        default: ./node_modules/.bin/cypress run --spec "$(circleci tests glob "../../src/apps/webclient/__regression__/*.spec.*" | circleci tests split | paste -sd "," -)" --reporter cypress-multi-reporters --reporter-options "configFile=reporterConfig.json"
      test_directory:
        type: string
        default: tests/regression
      application_base_url:
        type: string
        default: http://frontend.gousto.local:8080
      test_node_options:
        type: string
        default: --max-http-header-size=1000000
    docker: *circleci_node_browsers_image
    resource_class: large
    working_directory: /mnt/ramdisk
    parallelism: 5
    steps:
      - attach_workspace:
          at: /
      - run:
          name: Create minimal config file
          command: 'echo "{\"running_env\": \"local\", \"checkout_pk\": \"${CHECKOUTCOM_PK_STAGING}\"}" > src/apps/webclient/config/development-local.json5'
      - run:
          name: Build local application
          working_directory: src/apps/webclient
          command: NODE_CONFIG_ENV=development NODE_APP_INSTANCE=local npm run build
      - run:
          name: Update local DNS configuration
          command: echo '127.0.0.1 frontend.gousto.local' >> /etc/hosts
      - run:
          name: Start local application
          working_directory: src/apps/webclient
          command: NODE_CONFIG_ENV=development NODE_APP_INSTANCE=local yarn server
          background: true
      - run:
          name: Wait for application to be ready
          working_directory: scripts
          command: ./waitForHttpPath.sh 8080 / 10
      - when:
          condition:
            equal: [ web, << parameters.platform >> ]
          steps:
            - run:
                name: Run regression tests
                working_directory: << parameters.test_directory >>
                command: << parameters.test_command >>
                environment:
                  CYPRESS_baseUrl: << parameters.application_base_url >>
                  CYPRESS_platform: << parameters.platform >>
                  NODE_OPTIONS: << parameters.test_node_options >>
      - when:
          condition:
            equal: [ mobile, << parameters.platform >> ]
          steps:
            - run:
                name: Run regression tests
                working_directory: << parameters.test_directory >>
                command: << parameters.test_command >>
                environment:
                  CYPRESS_baseUrl: << parameters.application_base_url >>
                  CYPRESS_viewportWidth: 375
                  CYPRESS_viewportHeight: 667
                  CYPRESS_platform: << parameters.platform >>
                  NODE_OPTIONS: << parameters.test_node_options >>
      - run:
          name: Create reports
          when: on_fail
          working_directory: << parameters.test_directory >>
          command: yarn report
      - store_test_results:
          path: /mnt/ramdisk/tests/regression/test_results/cypress
      - store_artifacts:
          path: /mnt/ramdisk/tests/regression/reports/html
          destination: ./
      - store_artifacts:
          path: /mnt/ramdisk/tests/regression/videos
          destination: ./

  deploy-infrastructure-and-webclient-image:
    docker: *gousto_platform_image #stock image missing boto
    resource_class: medium
    working_directory: /mnt/ramdisk
    steps:
      - attach_workspace:
          at: /
      - run:
          name: Run Cloudformation to set up infrastructure and deploy the webclient image to ECS
          command: source ~/.circlerc && python ./ci_scripts/deploy_service.py --service webclient

workflows:
  version: 2

  e2e-manual:
    jobs:
      - setup-ci-variables-scripts:
          context: gousto-beta-aws-app-circleci
          filters:
            branches:
              only:
                - e2e-manual
      - install-dependencies:
          context: gousto-beta-aws-app-circleci
          requires:
            - setup-ci-variables-scripts
          filters:
            branches:
              only:
                - e2e-manual
      - test-e2e:
          context: gousto-beta-aws-app-circleci
          requires:
            - install-dependencies
          filters:
            branches:
              only:
                - e2e-manual

  lower-environment:
    jobs:
      - setup-ci-variables-scripts:
          context: gousto-beta-aws-app-circleci
          filters:
            branches:
              only:
                - /^env-.*/
      - install-dependencies:
          context: gousto-beta-aws-app-circleci
          requires:
            - setup-ci-variables-scripts
          filters:
            branches:
              only:
                - /^env-.*/
      - build-webclient:
          context: gousto-beta-aws-app-circleci
          requires:
            - install-dependencies
          filters:
            branches:
              only:
                - /^env-.*/
      - upload-assets-to-s3:
          context: gousto-beta-aws-app-circleci
          requires:
            - build-webclient
          filters:
            branches:
              only:
                - /^env-.*/
      - create-and-upload-webclient-docker-image-to-ecr:
          context: gousto-beta-aws-app-circleci
          requires:
            - build-webclient
          filters:
            branches:
              only:
                - /^env-.*/
      - deploy-infrastructure-and-webclient-image:
          name: deploy-infrastructure-and-webclient-image-to-lower-environment
          context: gousto-beta-aws-app-circleci
          requires:
            - create-and-upload-webclient-docker-image-to-ecr
            - upload-assets-to-s3
          filters:
            branches:
              only:
                - /^env-.*/

  staging-environment:
    jobs:
      - setup-ci-variables-scripts:
          context: gousto-beta-aws-app-circleci
          filters:
            branches:
              only:
                - develop
      - install-dependencies:
          context: gousto-beta-aws-app-circleci
          requires:
            - setup-ci-variables-scripts
          filters:
            branches:
              only:
                - develop
      - build-webclient:
          context: gousto-beta-aws-app-circleci
          requires:
            - install-dependencies
          filters:
            branches:
              only:
                - develop
      - upload-assets-to-s3:
          context: gousto-beta-aws-app-circleci
          requires:
            - build-webclient
          filters:
            branches:
              only:
                - develop
      - test-typecheck-and-report:
          context: gousto-beta-aws-app-circleci
          requires:
            - install-dependencies
          filters:
            branches:
              only:
                - develop
      - eslint-generate-report:
          context: gousto-beta-aws-app-circleci
          requires:
            - install-dependencies
          filters:
            branches:
              only:
                - develop
      - test-regression:
          name: test-regression-web
          platform: web
          context: gousto-beta-aws-app-circleci
          requires:
            - install-dependencies
          filters:
            branches:
              only:
                - develop
      - test-regression:
          name: test-regression-mobile
          platform: mobile
          context: gousto-beta-aws-app-circleci
          requires:
            - install-dependencies
          filters:
            branches:
              only:
                - develop
      - publish-code-health:
          context: gousto-beta-aws-app-circleci
          requires:
            - test-typecheck-and-report
            - eslint-generate-report
          filters:
            branches:
              only:
                - develop
      - create-and-upload-webclient-docker-image-to-ecr:
          context: gousto-beta-aws-app-circleci
          requires:
            - build-webclient
          filters:
            branches:
              only:
                - develop
      - deploy-infrastructure-and-webclient-image:
          name: deploy-infrastructure-and-webclient-image-to-staging
          context: gousto-beta-aws-app-circleci
          requires:
            - test-regression-web
            - test-regression-mobile
            - create-and-upload-webclient-docker-image-to-ecr
            - upload-assets-to-s3
          filters:
            branches:
              only:
                - develop
      - test-e2e:
          context: gousto-beta-aws-app-circleci
          requires:
            - deploy-infrastructure-and-webclient-image-to-staging
          filters:
            branches:
              only:
                - develop

  production-environment:
    jobs:
      - setup-ci-variables-scripts:
          context: gousto-prod-aws-app-circleci
          filters:
            branches:
              only:
                - master
      - install-dependencies:
          context: gousto-beta-aws-app-circleci
          requires:
            - setup-ci-variables-scripts
          filters:
            branches:
              only:
                - master
      - build-webclient:
          context: gousto-prod-aws-app-circleci
          requires:
            - install-dependencies
          filters:
            branches:
              only:
                - master
      - upload-source-maps-to-datadog:
          context: gousto-beta-aws-app-circleci
          requires:
            - build-webclient
          filters:
            branches:
              only:
                - master
      - upload-assets-to-s3:
          context: gousto-prod-aws-app-circleci
          requires:
            - build-webclient
          filters:
            branches:
              only:
                - master
      - create-and-upload-webclient-docker-image-to-ecr:
          context: gousto-prod-aws-app-circleci
          requires:
            - build-webclient
          filters:
            branches:
              only:
                - master
      - deploy-infrastructure-and-webclient-image:
          name: deploy-infrastructure-and-webclient-image-to-production
          context: gousto-prod-aws-app-circleci
          requires:
            - create-and-upload-webclient-docker-image-to-ecr
            - upload-assets-to-s3
          filters:
            branches:
              only:
                - master
